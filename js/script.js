/* Author: 
	George Dumitrescu
	dumitrescugeorge@gmail.com
*/

function loadData() {   
	var data = {"frames": [
		{
			"frame": {"x":380,"y":1794,"w":184,"h":252},
			"spriteSourceSize": {"x":188,"y":80,"w":184,"h":252},
		},
		{
			"frame": {"x":768,"y":1242,"w":186,"h":260},
			"spriteSourceSize": {"x":187,"y":72,"w":186,"h":260},
		},
		{
			"frame": {"x":192,"y":1524,"w":186,"h":270},
			"spriteSourceSize": {"x":187,"y":62,"w":186,"h":270},
		},
		{
			"frame": {"x":388,"y":1240,"w":190,"h":278},
			"spriteSourceSize": {"x":184,"y":54,"w":190,"h":278},
		},
		{
			"frame": {"x":2,"y":1238,"w":192,"h":284},
			"spriteSourceSize": {"x":183,"y":48,"w":192,"h":284},
		},
		{
			"frame": {"x":204,"y":946,"w":194,"h":292},
			"spriteSourceSize": {"x":181,"y":40,"w":194,"h":292},
		},
		{
			"filename": "DinoRun.swf/0006",
			"frame": {"x":604,"y":942,"w":194,"h":298},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":181,"y":34,"w":194,"h":298},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0007",
			"frame": {"x":804,"y":636,"w":196,"h":302},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":179,"y":30,"w":196,"h":302},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0008",
			"frame": {"x":404,"y":636,"w":198,"h":306},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":178,"y":26,"w":198,"h":306},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0009",
			"frame": {"x":2,"y":636,"w":200,"h":310},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":21,"w":200,"h":310},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0010",
			"frame": {"x":406,"y":322,"w":200,"h":312},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":19,"w":200,"h":312},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0011",
			"frame": {"x":816,"y":320,"w":200,"h":314},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":17,"w":200,"h":314},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0012",
			"frame": {"x":818,"y":2,"w":202,"h":316},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":174,"y":15,"w":202,"h":316},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0013",
			"frame": {"x":410,"y":2,"w":202,"h":318},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":175,"y":13,"w":202,"h":318},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0014",
			"frame": {"x":206,"y":2,"w":202,"h":318},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":174,"y":13,"w":202,"h":318},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0015",
			"frame": {"x":2,"y":2,"w":202,"h":318},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":174,"y":13,"w":202,"h":318},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0016",
			"frame": {"x":614,"y":2,"w":202,"h":316},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":174,"y":15,"w":202,"h":316},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0017",
			"frame": {"x":614,"y":320,"w":200,"h":314},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":17,"w":200,"h":314},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0018",
			"frame": {"x":204,"y":322,"w":200,"h":312},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":19,"w":200,"h":312},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0019",
			"frame": {"x":2,"y":322,"w":200,"h":312},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":176,"y":20,"w":200,"h":312},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0020",
			"frame": {"x":204,"y":636,"w":198,"h":308},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":178,"y":24,"w":198,"h":308},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0021",
			"frame": {"x":604,"y":636,"w":198,"h":304},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":178,"y":28,"w":198,"h":304},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0022",
			"frame": {"x":804,"y":940,"w":196,"h":300},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":179,"y":32,"w":196,"h":300},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0023",
			"frame": {"x":404,"y":944,"w":194,"h":294},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":181,"y":38,"w":194,"h":294},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0024",
			"frame": {"x":2,"y":948,"w":194,"h":288},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":181,"y":44,"w":194,"h":288},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0025",
			"frame": {"x":196,"y":1240,"w":190,"h":282},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":184,"y":50,"w":190,"h":282},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0026",
			"frame": {"x":2,"y":1524,"w":188,"h":276},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":186,"y":56,"w":188,"h":276},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0027",
			"frame": {"x":380,"y":1524,"w":186,"h":268},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":187,"y":64,"w":186,"h":268},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0028",
			"frame": {"x":580,"y":1242,"w":186,"h":260},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":187,"y":72,"w":186,"h":260},
			"sourceSize": {"w":550,"h":400}
		},
		{
			"filename": "DinoRun.swf/0029",
			"frame": {"x":380,"y":1794,"w":184,"h":252},
			"rotated": false,
			"trimmed": true,
			"spriteSourceSize": {"x":188,"y":80,"w":184,"h":252},
			"sourceSize": {"w":550,"h":400}
		}],
		"meta": {
			"app": "http://www.texturepacker.com",
			"version": "1.0",
			"image": "RinoAnim.png",
			"format": "RGBA8888",
			"size": {"w":1024,"h":2048},
			"scale": "1",
			"smartupdate": "$TexturePacker:SmartUpdate:368ec8b705ed795e1b40ccd9db5add2b$"
		}
		};
	return data.frames;
}

function gameClass () {

	var $this = this;				
	
	$this.a = 0;
	$this.b = 0;
	$this.la = 0;
	$this.lb = 0;
	
	$this.selector = undefined;
	
	$this.flag = '_hd';
	$this.height = 800;
	$this.width = 1280;
	$this.w = Math.round($this.width / $this.tileNr);
	$this.wf = Math.round($this.width / $this.tileNr - 1);
	
	$this.currentWidth = 0;
	$this.currentHeight = 0;
	$this.lastWidth = 0;
	$this.lastHeight = 0;
	$this.currentHeightPadding = 0;
	
	$this.pixelRatio = 1;
	
	$this.stage = undefined;
	
	$this.sky = undefined;
	$this.ground = undefined;
	
	$this.rino = {
		image: undefined,
		animateShow: false,
		animateHide: false,
		animateMove: false,
		close: true,
		states: undefined,
		frame: 0,
		x: 0,
		direction: 1
	};
	
	$this.menu = {
		images: {
			giantNut: undefined,
			titlePlate: undefined,
			coverRope: undefined,
			playNow: undefined,
			playNowOver: undefined,
			upgrades: undefined,
			upgradesOver: undefined,
			instructions: undefined,
			instructionsOver: undefined,
			moreGames: undefined,
			moreGamesOver: undefined,
			spider1: undefined,
			spider2: undefined,
			spider3: undefined,
		},
		animateShow: false,
		animateHide: false,
		close: true,
	};
	
	$this.instructions = {
		images: {
			close: undefined,
			closeTouch: undefined,
			tongue: undefined,
		},
		animateShow: false,
		animateHide: false,
		close: true,
	}
	
	$this.bkgs = new Array();
	
	$this.lFrame = 1;
	$this.fps = 0;
	
	$this.run = function (selector, processing) {
	
		if (window.devicePixelRatio !== undefined)
			$this.pixelRatio = 1;
			
		if (screen.height * $this.pixelRatio < 900) {
			$this.flag = '_sd';
		}
			

		$this.selector = selector;
	
		if ($this.selector == undefined) {
			alert('selector undefined');
			return false;
		}
		
		$this.rino.states = loadData();
		
		$this.stage = new Kinetic.Stage({
			container: 'main',
			width: 1280,
			height: 800,
		});
		
		$this.stage.setScale(1/$this.pixelRatio);
		
		$this.stageLoader();
	
	}
	
	$this.destroyStage = function () {
		
		$this.stage.clear();
		$this.stage.stop();
		$this.selector.html('');
		
	}
	
	$this.stageLoader = function () {
		
		var lyr = new Kinetic.Layer();
		
		var loadingText = new Kinetic.Text({
			x: $this.stage.attrs.width / 2,
			y: $this.stage.attrs.height / 2 - 30,
			text: "Loading...",
			fontSize: 30,
            fontFamily: "Calibri",
            textFill: "white",
            align: "center",
            verticalAlign: "middle"
		});
		
		lyr.add(loadingText);
		
		var loadBar = new Kinetic.Rect({
			x: $this.stage.attrs.width / 2 - $this.stage.attrs.width / 8,
			y: $this.stage.attrs.height / 2,
			width: $this.stage.attrs.width / 4,
			height: 10,
			fill: 'white',
		});
		
		lyr.add(loadBar);
		
		var loadBarStatus = new Kinetic.Rect({
			x: $this.stage.attrs.width / 2 - $this.stage.attrs.width / 8 + 2,
			y: $this.stage.attrs.height / 2 + 2,
			width: $this.stage.attrs.width / 4 - 4,
			height: 6,
			fill: 'black',
		});
		
		lyr.add(loadBarStatus);
		
		$this.stage.add(lyr);
		
		$this.stage.onFrame(function(frame){
			loadBarStatus.attrs.x = ($this.stage.attrs.width / 2 - $this.stage.attrs.width / 8 + 2) + loadedImages * (loadBar.attrs.width - 4) / totalImages;
			loadBarStatus.attrs.width = loadBar.attrs.width - 4 - (loadedImages * (loadBar.attrs.width - 4) / totalImages);
			lyr.draw();
		});
		
		$this.stage.start();
		
		loader = new PxLoader();
		
		var totalImages = 0;
		
		var loadedImages = 0;
		
		$this.sky = loader.addImage("img/SkyBg.png"); totalImages++;
		$this.ground = loader.addImage("img/GroundTile.png"); totalImages++;
		$this.rino.image = loader.addImage("img/RinoAnim.png"); totalImages++;
		$this.menu.images.giantNut = loader.addImage("img/CoverGiantNut.png"); totalImages++;
		$this.menu.images.titlePlate = loader.addImage("img/CoverTitlePlate.png"); totalImages++;
		$this.menu.images.coverRope = loader.addImage("img/CoverRope.png"); totalImages++;
		$this.menu.images.playNow = loader.addImage("img/CoverPlayNow.png"); totalImages++;
		$this.menu.images.playNowOver = loader.addImage("img/CoverPlayNowOver.png"); totalImages++;
		$this.menu.images.upgrades = loader.addImage("img/CoverUpgrades.png"); totalImages++;
		$this.menu.images.upgradesOver = loader.addImage("img/CoverUpgradesOver.png"); totalImages++;
		
		$this.menu.images.instructions = loader.addImage("img/CoverInstructions.png"); totalImages++;
		$this.menu.images.instructionsOver = loader.addImage("img/CoverInstructionsOver.png"); totalImages++;
		$this.menu.images.moreGames = loader.addImage("img/CoverMoreGames.png"); totalImages++;
		$this.menu.images.moreGamesOver = loader.addImage("img/CoverMoreGamesOver.png"); totalImages++;
		
		$this.menu.images.spider1 = loader.addImage("img/CoverSpider1.png"); totalImages++;
		$this.menu.images.spider2 = loader.addImage("img/CoverSpider2.png"); totalImages++;
		$this.menu.images.spider3 = loader.addImage("img/CoverSpider3.png"); totalImages++;
		
		$this.instructions.images.close = loader.addImage("img/CoverInstructionsClose.png"); totalImages++;
		$this.instructions.images.closeTouch = loader.addImage("img/CoverInstructionsCloseTouch.png"); totalImages++;
		$this.instructions.images.tongue = loader.addImage("img/CoverTongue.png"); totalImages++;
		
		loader.addProgressListener(function(e){
			loadedImages++;
		});
		
		loader.addCompletionListener(function(){
			$this.destroyStage();
			$this.stageCover(true);
		});
		
		loader.start();
		
	}
	
	$this.stageCover = function (execute) {
	
		if (execute == true) {
			
			$this.stage = new Kinetic.Stage({
				container: 'main',
				width: 1280,
				height: 800,
			});
			
			$this.stage.setScale(1/$this.pixelRatio);
			
			$this.update();
            
            $this.stage.on("touchstart mousedown", function() {
            	/*$this.stage.toDataURL(function(dataUrl) {
            		//alert(dataUrl);
                    
                    window.open(dataUrl);
                });*/
            	$this.touch = true;
            });
            
            $this.stage.on("touchmove", function() {
            	//$this.checkMove(true);
            });
            
            $this.stage.on("touchend", function() {
            	$this.touch = false;
            });
            
            //sky background
						
			$this.buildBackground($this.stage);
	        
	        // GroundTile
	        
	        $this.buildGround($this.stage);
	        
	        $this.buildRino($this.stage);
	        
	        $this.buildMenu($this.stage);
	        
			$this.buildInstructions($this.stage);
			
			$this.stage.onFrame(function(frame) {
				
				$this.animateGround($this.groundLayer);
				if ($this.menu.close == false && $this.menu.animateHide == false && $this.menu.animateShow == false)
					$this.animateGiantNut($this.menuLayer, frame);
				$this.animateRino($this.rinoLayer, frame);
				if ($this.menu.close == false && $this.menu.animateHide == true)
					$this.animateMenuHide($this.menuLayer, frame);
				if ($this.menu.close == true && $this.menu.animateShow == true)
					$this.animateMenuShow($this.menuLayer, frame);
				if ($this.menu.close == true && $this.instructions.animateShow == true)
					$this.animateInstructionsShow($this.instructionsLayer);
				if ($this.instructions.close == false && $this.instructions.animateHide == true)
					$this.animateInstructionsHide($this.instructionsLayer);
				if ($this.rino.close == false && $this.rino.animateHide == true)
					$this.animateRinoHide($this.rinoLayer);
				if ($this.rino.close == true && $this.rino.animateShow == true)
					$this.animateRinoShow($this.rinoLayer);
				if ($this.rino.close == false && $this.rino.animateMove == true)
					$this.animateRinoMove($this.rinoLayer);
			});
			
			$this.stage.start();
			
			$this.menuShow();
		}
	}
	
	$this.buildBackground = function (stage) {
		
		$this.background = new Kinetic.Layer();
			
        var SkyImg = new Kinetic.Image({
            x: 0,
            y: 0,
            image: $this.sky,
            width: 1280,
            height: 800
        });

        $this.background.add(SkyImg);
        
        stage.add($this.background);
	}
	
	$this.buildGround = function (stage) {
		
		$this.groundLayer = new Kinetic.Layer({
			rotationDeg: -2
		});
			
        var GroundTile = new Kinetic.Image({
            x: -20,
            y: 380,
            image: $this.ground,
            width: 1280,
            height: 600,
        });
        var GroundTile2 = new Kinetic.Image({
            x: 1259,
            y: 380,
            image: $this.ground,
            width: 1280,
            height: 600,
        });
        
		$this.groundLayer.add(GroundTile);
		$this.groundLayer.add(GroundTile2);
        
        stage.add($this.groundLayer);
	}
	
	$this.animateGround = function (layer) {
            
        var newX = layer.attrs.x - 5;
        
        var newY = layer.attrs.y + 0.175;
        
        if (newX < -1288) {
        	newX = -9;
        	newY = 0;
        }
        
        layer.setPosition(newX, newY);
        
        layer.draw();
	}
	
	$this.buildRino = function (stage) {
		
        $this.rinoLayer = new Kinetic.Layer({
        	x: -400,
        	y: -110,
        	rotationDeg: -2,
        	throttle: 1
        });
		
		$this.rinoLayer.setScale(1.2);
		
        var RinoTile = new Kinetic.Shape({
        	name: 'rino',
        	drawFunc: function() {
        		var context = this.getContext();
        		context.drawImage($this.rino.image, this.attrs._fx, this.attrs._fy, this.attrs._fw, this.attrs._fh, this.attrs._x, this.attrs._y, this.attrs._w, this.attrs._h);
        	},
        	_fx: $this.rino.states[$this.rino.frame].frame.x,
        	_fy: $this.rino.states[$this.rino.frame].frame.y,
        	_fw: $this.rino.states[$this.rino.frame].frame.w,
        	_fh: $this.rino.states[$this.rino.frame].frame.h,
        	_x: 188,
        	_y: 370,
        	_w: $this.rino.states[$this.rino.frame].frame.w,
        	_h: $this.rino.states[$this.rino.frame].frame.h,
        });
        
        $this.rinoLayer.add(RinoTile);
        
        $this.rinoLayer.hide();
        
        stage.add($this.rinoLayer);
		
	}
	
	$this.animateRino = function (layer, f) {
		
		$this.rino.frame++;
		
		if ($this.rino.frame % 2) {
			
			if ($this.rino.frame >= 60)
				$this.rino.frame = 1;
			
			var frame = ($this.rino.frame - 1) / 2;
			
			var rino = layer.get('.rino')[0];
			
			rino.attrs._fx = $this.rino.states[frame].frame.x;
			rino.attrs._fy = $this.rino.states[frame].frame.y;
			rino.attrs._fw = $this.rino.states[frame].frame.w;
			rino.attrs._fh = $this.rino.states[frame].frame.h;
			rino.attrs._fx = $this.rino.states[frame].frame.x;
			rino.attrs._x = $this.rino.states[frame].spriteSourceSize.x;
			rino.attrs._y = 290 + $this.rino.states[frame].spriteSourceSize.y;
			rino.attrs._w = $this.rino.states[frame].frame.w;
			rino.attrs._h = $this.rino.states[frame].frame.h;
			
			layer.draw();
			
		}
	}
	
	$this.rinoShow = function () {
		$this.rino.animateShow = true;
		$this.rinoLayer.show();
	}
	
	$this.animateRinoShow = function (layer) {
		
		layer.attrs.x += 2;
        
        if (layer.attrs.x >= -120) {
        	layer.attrs.x = -120;
        	$this.rino.animateShow = false;
        	$this.rino.close = false;
        }
        
        layer.draw();
        
	}
	
	$this.rinoMove = function (x) {
		$this.rino.x = x;
		$this.rino.animateMove = true;
	}
	
	$this.animateRinoMove = function (layer) {
		
		if (layer.attrs.x > rino.x)
			$this.rino.direction = -1;
		
		if (layer.attrs.x < rino.x)
			$this.rino.direction = 1;
        
        layer.attrs.x += 1 * rino.direction;
        
        if (layer.attrs.x == $this.rino.x) {
        	$this.rino.animateMove = false;
        }
        
        layer.draw();
        
	}
	
	$this.animateRinoHide = function (layer) {
		
		layer.attrs.x -= 2;
        
        if (layer.attrs.x <= -400) {
        	layer.attrs.x = -400;
        	$this.rino.animateHide = false;
        	$this.rino.close = true;
        	
        	layer.hide();
        }
        
        layer.draw();
        
	}
	
	$this.buildSpiderSpier = function (stage) {
		
		$this.spierLayer = new Kinetic.Layer({
			
		});
		
		var spier1 = new Kinetic.Image({
			
		});
		
		stage.add($this.spierLayer);
		
		$this.spiderLayer = new Kinetic.Layer({
			x: 80
		});
		
		$this.spiderLayer.setScale(0.9);
		
		var spider1 = new Kinetic.Image({
			name: 'spider1',
			x: 1000,
			y: 500,
			centerOffset: {
				x: 123/2,
				y: 960
			},
			image: $this.menu.images.spider1,
            width: 123,
            height: 960,
            rotationDeg: 35,
            draggable: true,
		});
		
		$this.spiderLayer.add(spider1);
		
		var spider2 = new Kinetic.Image({
			name: 'spider2',
			x: 900,
			y: 250,
			centerOffset: {
				x: 109/2,
				y: 960
			},
			image: $this.menu.images.spider2,
            width: 109,
            height: 960,
            rotationDeg: 15,
            draggable: true,
		});
		
		$this.spiderLayer.add(spider2);
		
		var spider3 = new Kinetic.Image({
			name: 'spider3',
			x: 710,
			y: 300,
			centerOffset: {
				x: 94/2,
				y: 961
			},
			image: $this.menu.images.spider3,
            width: 94,
            height: 961,
            rotationDeg: 10,
            draggable: true,
		});
		
		$this.spiderLayer.add(spider3);
		
		stage.add($this.spiderLayer);
		
	}
	
	$this.buildMenu = function (stage) {
		
		$this.buildSpiderSpier(stage);
		
		$this.menuLayer = new Kinetic.Layer({
			x: 200,
			centerOffset: {
                x: 400 / 2,
                y: 0
           	},
           	rotation: 3,
		});
		
		var CoverRope = new Kinetic.Image({
			name: 'coverRope',
			x: 360,
			y: 10,
			image: $this.menu.images.coverRope,
            width: 84,
            height: 1260,
            rotationDeg: -3,
		});
		
		$this.menuLayer.add(CoverRope);
	    
        var GiantNut = new Kinetic.Image({
        	name: 'giantNut',
            x: 400,
            y: 0,
            centerOffset: {
                x: 617 / 2,
                y: 617 / 2
            },
            image: $this.menu.images.giantNut,
            width: 617,
            height: 617,
        });
        
        $this.menuLayer.add(GiantNut);
        
        var TitlePlate = new Kinetic.Image({
        	name: 'titlePlate',
            x: 450,
            y: 100,
            centerOffset: {
                x: 570 / 2,
                y: 155 / 2
            },
            image: $this.menu.images.titlePlate,
            width: 570,
            height: 155,
            rotationDeg: -5,
        });
        
        $this.menuLayer.add(TitlePlate);
        
        var PlayNow = new Kinetic.Image({
        	name: 'playNow',
            x: 410,
            y: 340,
            image: $this.menu.images.playNow,
            width: 305,
            height: 100,
            rotationDeg: -10,
        });
        
        PlayNow.on('mousedown touchstart', function(){
        	PlayNow.image = $this.menu.images.playNowOver;
        });
        
        PlayNow.on('mouseup touchend', function(){
        	PlayNow.image = $this.menu.images.playNow;
        });
        
        $this.menuLayer.add(PlayNow);
        
        var Upgrades = new Kinetic.Image({
        	name: 'upgrades',
            x: 415,
            y: 445,
            image: $this.menu.images.upgrades,
            width: 305,
            height: 100,
            rotationDeg: -7,
        });
        
        Upgrades.on('mousedown touchstart', function(){
        	Upgrades.image = $this.menu.images.upgradesOver;
        });
        
        Upgrades.on('mouseup touchend', function(){
        	Upgrades.image = $this.menu.images.upgrades;
        });
        
        $this.menuLayer.add(Upgrades);
        
		var Instructions = new Kinetic.Image({
        	name: 'upgrades',
            x: 425,
            y: 580,
            image: $this.menu.images.instructions,
            width: 305,
            height: 100,
            rotationDeg: -5,
        });
        
        Instructions.on('mousedown touchstart', function(){
        	Instructions.image = $this.menu.images.instructionsOver;
        });
        
        Instructions.on('mouseup touchend', function(){
        	$this.menu.animateHide = true;
        	$this.instructionsShow();
        	$this.rinoMove(-200);
        	Instructions.image = $this.menu.images.instructions;
        });
        
        $this.menuLayer.add(Instructions);
        
        var MoreGames = new Kinetic.Image({
        	name: 'upgrades',
            x: 425,
            y: 680,
            image: $this.menu.images.moreGames,
            width: 305,
            height: 100,
            rotationDeg: -2,
        });
        
        MoreGames.on('mousedown touchstart', function(){
        	MoreGames.image = $this.menu.images.moreGamesOver;
        });
        
        MoreGames.on('mouseup touchend', function(){
        	MoreGames.image = $this.menu.images.moreGames;
        });
        
        $this.menuLayer.add(MoreGames);
        
        $this.menuLayer.hide();
        
        stage.add($this.menuLayer);
        
	}
	
	$this.animateGiantNut = function (layer, frame) {
		//frame: lastTime time timeDiff
        var shape = layer.get('.giantNut')[0];
        
        // revolutions per second
        var angularDiff = 0.4 * 2 * Math.PI * frame.timeDiff / 1000;
        
        shape.attrs.rotation = shape.attrs.rotation + angularDiff;
        
        layer.draw();
	}
	
	$this.animateMenuHide = function (layer, frame) {
        
        var angularSpeed = 0.4;
        // revolutions per second
        var angularDiff = angularSpeed * 2 * Math.PI * frame.timeDiff * 2 / 1000;
        
        layer.attrs.rotation = layer.attrs.rotation + angularDiff;
        
        if (layer.attrs.rotation > 3) {
        	$this.menu.animateHide = false;
        	$this.menu.close = true;
        	layer.hide();
        }
        	
        
        layer.draw();
	}
	
	$this.menuShow = function () {
		$this.menu.animateShow = true;
		$this.menuLayer.show();
	}
	
	$this.animateMenuShow = function (layer, frame) {
        
        var angularSpeed = 0.4;
        // revolutions per second
        var angularDiff = angularSpeed * 2 * Math.PI * frame.timeDiff * 2 / 1000;
        
        layer.attrs.rotation = layer.attrs.rotation - angularDiff;
        
        if (layer.attrs.rotation < 0) {
        	layer.attrs.rotation = 0;
        	$this.menu.animateShow = false;
        	$this.menu.close = false;
        	
        	$this.rinoShow();
        }
        
        layer.draw();
	}
	
	$this.buildInstructions = function(stage) {
		
		$this.instructionsLayer = new Kinetic.Layer();
		
		var Close = new Kinetic.Image({
			name: 'close',
			x: -207,
			y: 10,
			image: $this.instructions.images.close,
            width: 207,
            height: 205,
            rotationDeg: -3,
		});
		
		Close.on('mousedown touchstart', function(){
        	Close.image = $this.instructions.images.closeTouch;
        });
        
        Close.on('mouseup touchend', function(){
        	Close.image = $this.instructions.images.close;
        	$this.instructions.animateHide = true;
        	$this.rinoMove(-120);
        });
		
		$this.instructionsLayer.add(Close);
		
		var Tongue = new Kinetic.Image({
			name: 'tongue',
			x: 240,
			y: 900,
			image: $this.instructions.images.tongue,
            width: 865,
            height: 890,
            rotationDeg: -7,
		});
		
		$this.instructionsLayer.add(Tongue);
		
		$this.instructionsLayer.hide();
		
		stage.add($this.instructionsLayer);
		
	}
	
	$this.animateInstructionsHide = function (layer) {
		//frame: lastTime time timeDiff
        layer.show();
		
		var closeMoved = false;
		var tongueMoved = false;
		
		var tongue = layer.get('.tongue')[0];
		
		if (tongue.attrs.y >= 900) {
			tongueMoved = true;
		}
		
		if (tongueMoved == true) {
			var close = layer.get('.close')[0];
		
			close.attrs.x = close.attrs.x - 5;
			
			if (close.attrs.x <= -207) {
				closeMoved = true;
			}
			
			if (tongue.attrs.y > 900) {
				tongue.attrs.y = 900;
			}
		} else {
			tongue.attrs.y = tongue.attrs.y + 15;
		}
		
		if (closeMoved == true && tongueMoved == true) {
			$this.instructions.animateHide = false;
			$this.instructions.close = true;
			$this.menuShow();
			layer.hide();
		}
        
        layer.draw();
	}
	
	$this.instructionsShow = function () {
		$this.instructions.animateShow = true;
		$this.instructionsLayer.show();
	}
	
	$this.animateInstructionsShow = function (layer) {
		
		var closeMoved = false;
		var tongueMoved = false;
		
		var close = layer.get('.close')[0];
		
		if (close.attrs.x >= 20) {
			closeMoved = true;
		}
		
		if (closeMoved == true) {
			var tongue = layer.get('.tongue')[0];
			
			tongue.attrs.y = tongue.attrs.y - 15;
			
			if (tongue.attrs.y <= 50) {
				tongueMoved = true;
				tongue.attrs.y = 50;
			}
			
			if (close.attrs.x > 20) {
				close.attrs.x = 20;
			}
		} else {
			close.attrs.x = close.attrs.x + 5;
		}
		
		if (closeMoved == true && tongueMoved == true) {
			$this.instructions.animateShow = false;
    		$this.instructions.close = false;
		}
        
        layer.draw();
	}
	
	$this.update = function () {
		
		if ($this.selector.width() < $this.selector.height())
			var ratio = $this.selector.width() / 1280;
		if ($this.selector.height() < $this.selector.width()) {
			var ratio = $this.selector.height() / 800;
		}
		
		if (ratio > 1)
			ratio = 1;
		
		if ($this.stage != undefined) {
			$this.stage.setSize(1280 * ratio, 800 * ratio);
			$this.stage.setScale(ratio);
		}
		
		$('.kineticjs-content').width(1280 * ratio).height(800 * ratio);
		
		return false;
		
	}
	
	$this.vRotate = function () {
		if ($this.vGyroEnable == true) {
			if ($this.wDirection == 'right')
				$this.vGyro--;
			if ($this.wDirection == 'left')
				$this.vGyro++;
				
			if ($this.vGyro >= 181)
				$this.vGyro = -179;
				
			if ($this.vGyro < -181)
				$this.vGyro = 179;
				
			$this.rotate($this.vGyro, 0);
		
			setTimeout('game.vRotate()', 10);
		}
	}
	
	$this.rotate = function (a, b) {
		
		if ($this.gyroEnable == false)
			var ba = Math.round(a*10000)/10000;
		else
			var ba = Math.round(a);
	
		if ($this.vGyroEnable == false) {
			if (ba > $this.la) {
				$this.startWalk();
				$this.wDirection = 'left';
			} else if (ba == $this.la) {
				$this.stopWalk();								
			} else {
				$this.startWalk();
				$this.wDirection = 'right';
			}
			$this.vGyro = Math.round(ba);
		}
	
		var diff = Math.round(0 + ($this.currentWidth*a)/360) - Math.round($this.currentWidth / 2) + Math.round($this.selector.parent().width() / 2);
		
		$this.a = diff;
		
		$this.b = 0 - b;
		
		$this.la = ba;
		
		if ($this.gyroEnable == false && ($this.mouseCapable == false || $this.mouseEnable == true))
			$this.walkTimeoutId = setTimeout('game.checkMove()', 100);
	
	}
	

	return $this;
}

var game = gameClass();

game.run($('#main'));

$(window).resize(function(){
		
	game.update();
		
});	

$(document).ready(function(){

	game.update();

	setTimeout(function() { window.scrollTo(0, 1) }, 100);
	
	$(window).resize(function(){
			
		game.update();
			
	});

});